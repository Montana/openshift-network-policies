# openshift-network-policies

Cluster Security for Kubernetes and OpenShift automatically scans these deployments for security risk and policy violations as soon as they are submitted to the cluster.

## Installing the `roxctl` CLI

To install Red Hat Advanced Cluster Security for Kubernetes you must install the `roxctl` CLI by downloading the binary. You can install roxctl on Linux, Windows, or macOS.

You can install the roxctl CLI binary on Linux by the following, download the latest version of the roxctl CLI:


```bash
curl -O https://mirror.openshift.com/pub/rhacs/assets/3.67.2/bin/Linux/roxctl
```

Make the roxctl binary executable:

```bash
chmod +x roxctl
```

Place the `roxctl` binary in a directory that is on your `PATH`:

To check your `PATH`, execute the following command:

```bash
echo $PATH
```

Verify the roxctl version you have installed:

```bash
roxctl version
```

You can install the `roxctl` CLI binary on macOS by using the following procedure:

```bash
curl -O https://mirror.openshift.com/pub/rhacs/assets/3.67.2/bin/Darwin/roxctl
```

Remove all extended attributes from the binary:


```bash
xattr -c roxctl
```

Make the `roxctl` binary executable:


```bash
chmod +x roxctl
```

Place the ```roxctl``` binary in a directory that is on your `PATH`:

To check your `PATH`, execute the following command:


```bash
echo $PATH
```

## `roxctl` version

First run:
```bash
roxctl version
```

The main component of Red Hat Advanced Cluster Security for Kubernetes is called Central. You can install Central on OpenShift Container Platform by using the interactive installer. You deploy Central only once and you can monitor multiple separate clusters by using the same installation.


## Interactive installer

Use the interactive installer to generate the required secrets, deployment configurations, and deployment scripts for your environment.

Run the interactive install command:


```bash
roxctl central generate interactive
```

```openshift
Enter path to the backup bundle from which to restore keys and certificates (optional):
Enter PEM cert bundle file (optional): 
Enter administrator password (default: autogenerated):
Enter orchestrator (k8s, openshift): openshift
Enter the directory to output the deployment bundle to (default: "central-bundle"):
Enter the OpenShift major version (3 or 4) to deploy on (default: "0"): 4
Enter Istio version when deploying into an Istio-enabled cluster (leave empty when not running Istio) (optional):
Enter the method of exposing Central (route, lb, np, none) (default: "none"): route 
Enter main image to use (default: "stackrox.io/main:3.0.61.1"):
Enter whether to run StackRox in offline mode, which avoids reaching out to the Internet (default: "false"):
Enter whether to enable telemetry (default: "true"):
Enter the deployment tool to use (kubectl, helm, helm-values) (default: "kubectl"):
Enter Scanner DB image to use (default: "stackrox.io/scanner-db:2.15.2"):
Enter Scanner image to use (default: "stackrox.io/scanner:2.15.2"):
Enter Central volume type (hostpath, pvc): pvc 
Enter external volume name (default: "stackrox-db"):
Enter external volume size in Gi (default: "100"):
Enter storage class name (optional if you have a default StorageClass configured)
```
Make sure you `chown` the sandbox:

```bash
sudo chcon -Rt svirt_sandbox_file_t <full_volume_path>
```

However, Red Hat does not recommend modifying the SELinux policy, instead use PVC when installing on OpenShift Container Platform. On completion, the installer creates a folder named central-bundle, which contains the necessary YAML manifests and scripts to deploy Central. In addition, it shows on-screen instructions for the scripts you need to run to deploy additional trusted certificate authorities, Central and Scanner, and the authentication instructions for logging into the RHACS portal along with the autogenerated password if you did not provide one when answering the prompts.

## Running the Central installation scripts

After you run the interactive installer, you can run the setup.sh script to install Central.

Run the following:


```bash
./central-bundle/central/scripts/setup.sh
```

Create the necessary resources:

```bash
oc create -R -f central-bundle/central
```

Check the deployment progress:


```bash
oc get pod -n stackrox -w
```
After Central is running, find the RHACS portal IP address and open it in your browser. Depending on the exposure method you selected when answering the prompts, use one of the following methods to get the IP address.

## Exposure method	Command	Address	Example

```bash
oc -n stackrox get route central
```

The address under the `HOST/PORT` column in the output:

https://central-stackrox.example.route

## Node Port

```bash
oc get node -owide && oc -n stackrox get svc central-loadbalancer
```

## IP or hostname of any node, on the port shown for the service

https://198.51.100.0:31489

## Load Balancer

```bash
oc -n stackrox get svc central-loadbalancer
```
Or:

```bash
EXTERNAL-IP or hostname shown for the service, on port 443
https://192.0.2.0
```

If you have selected autogenerated password during the interactive install, you can run the following command to see it for logging into Central:


```bash
cat central-bundle/password
```
## Installing Scanner

You can configure Red Hat Advanced Cluster Security for Kubernetes to obtain image data from a variety of open-source and commercial image scanners.

However, Red Hat Advanced Cluster Security for Kubernetes also provides an image vulnerability scanner component, called Scanner. It enriches deployments with image vulnerability information.

Red Hat recommends deploying Scanner so that it can scan all images, including the images from public registries, for vulnerabilities. You can deploy the Scanner in the same cluster with Central.

## Prerequisites

You must configure your image registry to allow Scanner to download and scan images. Usually, image registry integrations are created automatically by Red Hat Advanced Cluster Security for Kubernetes.

## Procedure

Run the following command to configure image registry access:


```bash
./central-bundle/scanner/scripts/setup.sh
```

After the script finishes, run the following command to create the scanner service:

```bash
oc create -R -f central-bundle/scanner
```

## Installing Sensor

To monitor a cluster, you must deploy Sensor. You must deploy Sensor into each cluster that you want to monitor. The following steps describe adding Sensor by using the RHACS portal.

## Let's monitor

On the RHACS portal, navigate to Platform Configuration â†’ Clusters.

Select + New Cluster.

Specify a name for the cluster.

Provide appropriate values for the fields based on where you are deploying the Sensor.

If you are deploying Sensor in the same cluster, accept the default values for all the fields.

If you are deploying into a different cluster, replace central.stackrox.svc:443 with a load balancer, node port, or other address, including the port number, that is accessible from the other cluster.

If you are using a non-gRPC capable load balancer, such as HAProxy, AWS Application Load Balancer (ALB), or AWS Elastic Load Balancing (ELB), use the WebSocket Secure (wss) protocol. To use wss:

Prefix the address with `wss://.`

Add the port number after the address, for example, wss://stackrox-central.example.com:443.

Click Next to continue with the Sensor setup.

Click Download YAML File and Keys to download the cluster bundle (zip archive).

The cluster bundle zip archive includes unique configurations and keys for each cluster. Do not reuse the same files in another cluster.

From a system that has access to the monitored cluster, unzip and run the sensor script from the cluster bundle:

```bash
unzip -d sensor sensor-<cluster_name>.zip
```

```bash
./sensor/sensor.sh
```

If you get a warning that you do not have the required permissions to deploy Sensor, follow the on-screen instructions, or contact your cluster administrator for assistance.

After Sensor is deployed, it contacts Central and provides cluster information.

## 
Verification
Return to the RHACS portal and check if the deployment is successful. If it is successful, a green checkmark appears under section #2. If you do not see a green checkmark, use the following command to check for problems:

On OpenShift Container Platform:


```bash
oc get pod -n stackrox -w
```

On Kubernetes:

```bash
kubectl get pod -n stackrox -w
```

Click Finish to close the window.

After installation, Sensor starts reporting security information to Red Hat Advanced Cluster Security for Kubernetes and the RHACS portal dashboard begins showing deployments, images, and policy violations from the cluster on which you have installed the Sensor.

## Verifying installation

After you complete the installation, navigate to the RHACS portal and run a few vulnerable applications to evaluate the results of security assessments and policy violations.

The sample applications listed in the following section contain critical vulnerabilities and they are specifically designed to verify the build and deploy-time assessment features of Red Hat Advanced Cluster Security for Kubernetes.

Find the address of the RHACS portal based on your exposure method:

For a route:

```bash
oc get route central -n stackrox
```

For a load balancer:

```bash
oc get service central-loadbalancer -n stackrox
```

For port forward:

```bash
oc port-forward svc/central 18443:443 -n stackrox
```

Navigate to https://localhost:18443/.

Create a new project:

```bash
oc new-project test
```

Start some applications with critical vulnerabilities:

```bash
oc run shell --labels=app=shellshock,team=test-team \
  --image=vulnerables/cve-2014-6271 -n test
  ```
Then try:

```bash
oc run samba --labels=app=rce \
  --image=vulnerables/cve-2017-7494 -n test
```
Red Hat Advanced Cluster Security for Kubernetes automatically scans these deployments for security risk and policy violations as soon as they are submitted to the cluster.

Navigate to the RHACS portal to view the violations. You can log in to the RHACS portal by using the default username admin and the generated password.
